<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Live Order Book</title>
        <style>
            body {font-family:'Roboto', sans-serif;/*width:1010px;*/margin:0 auto;}
            h1 {font-size:30px;color:#666;margin:0 0 0px 0;text-align:center;}
            .column h2 {text-align:left;}
            .column:nth-child(3) h2 {text-align:right;}
            .column:nth-child(3) div {text-align:right;}
			div.scrollable {width: 100%;height: 100%;margin: 0;padding: 0;overflow: scroll;}
			input[type=number]{width: 50px;} 
			link_button {
				 background:none!important;
				 color:inherit;
				 border:solid; 
				 padding:0!important;
				 font: inherit; 
				 cursor: pointer;
				}
        </style>
    <body style="">
		<font color="Blue" size="5"><link_button onclick='set_text_language("en_us")'>English</link_button></font><font color="Red" size="5">  <link_button onclick='set_text_language("zh_cn")'>&nbsp&nbsp&nbsp中文&nbsp&nbsp&nbsp</link_button></font>
        <h1><span id="orderbook_header" data-dict-value="orderbook_header">Order Book</span> (v0.3)
			<select id="crypto_type" name="crypto_type" onchange="set_currency_type()">
				<option value="BTC" data-dict-value="btc_usd_option">BTC/USD</option>
				<option value="BCH" data-dict-value="bch_usd_option">BCH/USD</option>
			</select>
		</h1>
		
		<table border=1>
		<tr>
		<td id="bitstamp_header">
			<font size="2">
			<button type=button onclick="start_exchange('Bitstamp')">Start</button>
			<button type=button onclick="stop_exchange('Bitstamp')">Stop</button>
			<br><B><span data-dict-value="bitstamp">Bitstamp</span> <span data-dict-value="account_details">Account Details</span></B>
			<BR>
			<span data-dict-value="usd_balance">USD Balance:</span>
			<div style="display: inline" id="usd_balance_placeholder_bitstamp"><span data-dict-value="not_available">N/A</span></div></div>
			<BR>
			<div style="display: inline" id="crypto_available_balance_placeholder_bitstamp"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			</font>
		</td>
		<td id="bitfinex_header">
			<font size="2">
			<button type=button onclick="start_exchange('Bitfinex')">Start</button>
			<button type=button onclick="stop_exchange('Bitfinex')">Stop</button>
			<br><B><span data-dict-value="bitfinex">Bitfinex</span> <span data-dict-value="account_details">Account Details</span></B>
			<BR>
			<span data-dict-value="usd_balance">USD Balance:</span>
			<div style="display: inline" id="usd_balance_placeholder_bitfinex"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			<div style="display: inline" id="crypto_available_balance_placeholder_bitfinex"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			</font>
		</td>
		<td id="gdax_header">
			<font size="2">
			<button type=button onclick="start_exchange('GDAX')">Start</button>
			<button type=button onclick="stop_exchange('GDAX')">Stop</button>
			<br><B><span data-dict-value="gdax">GDAX</span> <span data-dict-value="account_details">Account Details</span></B>
			<BR>
			<span data-dict-value="usd_balance">USD Balance:</span>
			<div style="display: inline" id="usd_balance_placeholder_gdax"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			<div style="display: inline" id="crypto_available_balance_placeholder_gdax"><span data-dict-value="not_available">N/A</span></div>			
			<BR>
			</font>
		</td>
		<td id="kraken_header">
			<font size="2">
			<button type=button onclick="start_exchange('Kraken')">Start</button>
			<button type=button onclick="stop_exchange('Kraken')">Stop</button>			
			<br><B><span data-dict-value="kraken">Kraken</span> <span data-dict-value="account_details">Account Details</span></B>
			<BR>
			<span data-dict-value="usd_balance">USD Balance:</span>
			<div style="display: inline" id="usd_balance_placeholder_kraken"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			<div style="display: inline" id="crypto_available_balance_placeholder_kraken"><span data-dict-value="not_available">N/A</span></div>			
			<BR>
			</font>
		</td>		
		<td id="unified_header">
			<font size="2">
			<B><span data-dict-value="unified">Unified</span> <span data-dict-value="account_details">Account Details</span></B>
			<BR>
			<span data-dict-value="usd_balance">USD Balance:</span>
			<div style="display: inline" id="usd_balance_placeholder_unified"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			<div style="display: inline" id="crypto_available_balance_placeholder_unified"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			</font>
		</td>
		<td>
			<font size="2">
			<select id="sign_in_exchange" onchange="set_sign_in_exchange()">
				<option value="Bitstamp" data-dict-value="bitstamp">Bitstamp</option>
				<option value="Bitfinex" data-dict-value="bitfinex">Bitfinex</option>
				<option value="Kraken" data-dict-value="kraken">Kraken</option>
			</select>
			<B><span data-dict-value="credentials">Credentials, Current Signed-in User:</span> </B>
			<div style="display: inline" id="user_placeholder" name="user_placeholder"><span data-dict-value="not_available">N/A</span></div>
			<BR>
			<span data-dict-value="account_number">Account number:</span>
			<input type="number" id="account_number" name="account_number">
			<BR>
			<span data-dict-value="api_key">API Key:</span>
			<input id="api_key" name="api_key">
			<span data-dict-value="taker_fee">Taker Fee</span>(%): <input type="number" id="taker_fee">
			<span data-dict-value="maker_fee">Maker Fee</span>(%): <input type="number" id="maker_fee"><br>
			<span data-dict-value="secret">Secret:</span>
			<input type="password" id="secret" name="secret">
			<button type=button onclick="set_credentials()" name="btnSetCredentials" id="btnSetCredentials" data-dict-value="set_credentials">Set Credentials</button>
			<button type=button onclick="exchange_logout()" name="btnLogout" id="btnLogout"ת data-dict-value="logout">Logout</button><br>
			</font>
		</td>		
		</tr>
		<tr>
		<td style="width:7%" id="bitstamp_content">
			<div style="display: inline" class="column">
				<font size="2"><B><span data-dict-value="bitstamp">Bitstamp</span> <span data-dict-value="asks">Asks</span></B><BR>
				<div style="display: inline" id="bitstamp_asks_placeholder">Bitstamp Asks<br></div>
			</div>
			<B><span data-dict-value="spread">Spread (USD)</span><BR><span data-dict-value="current">Current:</span> </B><div style="display: inline" id="bitstamp_spread_placeholder"><br></div>
			<BR>
			<B><span data-dict-value="average">Average:</span> </B><div style="display: inline" id="bitstamp_average_spread_placeholder"><br></div><br>
			<B><span data-dict-value="last">Last:</span> </B><div style="display: inline" id="bitstamp_last_placeholder"><br></div><br>
			<!--<B><span data-dict-value="average_sell_rate">Sell rate (</span><span id="size_rate_1">BTC</span><span data-dict-value="short_second">/Sec):</span> </B><div style="display: inline" id="bitstamp_sell_rate_placeholder"></div><br>			
			<B><span data-dict-value="average_buy_rate">Buy rate (</span><span id="size_rate_2">BTC</span><span data-dict-value="short_second">/Sec):</span> </B><div style="display: inline" id="bitstamp_buy_rate_placeholder"></div><br>
			<B><span data-dict-value="sell_price">Sell price:</span> </B><div style="display: inline" id="bitstamp_sell_price_placeholder"></div><br>
			<B><span data-dict-value="buy_price">Buy price:</span> </B><div style="display: inline" id="bitstamp_buy_price_placeholder"></div><br>-->
			<div class="column">
				<B><span data-dict-value="bitstamp">Bitstamp</span> <span data-dict-value="bids">Bids</span></B><BR>
				<div style="display: inline" id="bitstamp_bids_placeholder">Bitstamp Bids<br></div>
				</font>
			</div>
		</td>
		<td style="width:7%" id="bitfinex_content">
			<div style="display: inline" class="column">
				<font size="2"><B><span data-dict-value="bitfinex">Bitfinex</span> <span data-dict-value="asks">Asks</span></B><BR>
				<div style="display: inline" id="bitfinex_asks_placeholder">Bitfinex Asks<br></div>
			</div>
			<B><span data-dict-value="spread">Spread (USD)</span><BR><span data-dict-value="current">Current:</span> </B><div style="display: inline" id="bitfinex_spread_placeholder"><br></div>
			<BR>
			<B><span data-dict-value="average">Average:</span> </B><div style="display: inline" id="bitfinex_average_spread_placeholder"><br></div><br>
			<B><span data-dict-value="last">Last:</span> </B><div style="display: inline" id="bitfinex_last_placeholder"><br></div><br>
			<!--<B><span data-dict-value="average_sell_rate">Sell rate (</span><span id="size_rate_3">BTC</span><span data-dict-value="short_second">/Sec):</span> </B><div style="display: inline" id="bitfinex_sell_rate_placeholder"></div><br>			
			<B><span data-dict-value="average_buy_rate">Buy rate (</span><span id="size_rate_4">BTC</span><span data-dict-value="short_second">/Sec):</span> </B><div style="display: inline" id="bitfinex_buy_rate_placeholder"></div><br>
			<B><span data-dict-value="sell_price">Sell price:</span> </B><div style="display: inline" id="bitfinex_sell_price_placeholder"></div><br>
			<B><span data-dict-value="buy_price">Buy price:</span> </B><div style="display: inline" id="bitfinex_buy_price_placeholder"></div><br>-->
			<div class="column">
				<B><span data-dict-value="bitfinex">Bitfinex</span> <span data-dict-value="bids">Bids</span></B><BR>
				<div style="display: inline" id="bitfinex_bids_placeholder">Bitfinex Bids<br></div>
				</font>
			</div>
		</td>
		<td style="width:7%" id="gdax_content">
			<div style="display: inline" class="column">
				<font size="2"><B><span data-dict-value="gdax">GDAX</span> <span data-dict-value="asks">Asks</span></B><BR>
				<div style="display: inline" id="gdax_asks_placeholder">GDAX Asks<br></div>
			</div>
			<B><span data-dict-value="spread">Spread (USD)</span><BR><span data-dict-value="current">Current:</span> </B><div style="display: inline" id="gdax_spread_placeholder">GDAX Spread<br></div>
			<BR>
			<B><span data-dict-value="average">Average:</span> </B><div style="display: inline" id="gdax_average_spread_placeholder">GDAX Spread<br></div><br>
			<B><span data-dict-value="last">Last:</span> </B><div style="display: inline" id="gdax_last_placeholder"><br></div><br>
			<div class="column">
				<B><span data-dict-value="gdax">GDAX</span> <span data-dict-value="bids">Bids</span></B><BR>
				<div style="display: inline" id="gdax_bids_placeholder">GDAX Bids<br></div>
				</font>
			</div>
		</td>
		<td style="width:7%" id="kraken_content">
			<div style="display: inline" class="column">
				<font size="2"><B><span data-dict-value="kraken">Kraken</span> <span data-dict-value="asks">Asks</span></B><BR>
				<div style="display: inline" id="kraken_asks_placeholder">Kraken Asks<br></div>
			</div>
			<B><span data-dict-value="spread">Spread (USD)</span><BR><span data-dict-value="current">Current:</span> </B><div style="display: inline" id="kraken_spread_placeholder">Kraken Spread<br></div>
			<BR>
			<B><span data-dict-value="average">Average:</span> </B><div style="display: inline" id="kraken_average_spread_placeholder">Kraken Spread<br></div><br>
			<B><span data-dict-value="last">Last:</span> </B><div style="display: inline" id="kraken_last_placeholder"><br></div><br>
			<div class="column">
				<B><span data-dict-value="kraken">Kraken</span> <span data-dict-value="bids">Bids</span></B><BR>
				<div style="display: inline" id="kraken_bids_placeholder">Kraken Bids<br></div>
				</font>
			</div>
		</td>		
		<td style="width:8%" id="unified_content">
			<div style="display: inline" class="column">
				<font size="2"><B><span data-dict-value="unified">Unified</span> <span data-dict-value="asks">Asks</span></B><BR>
				<div style="display: inline" id="unified_asks_placeholder"><span data-dict-value="unified">Unified</span> <span data-dict-value="asks">Asks</span><br></div>
			</div>
			<B><span data-dict-value="spread">Spread (USD)</span><BR><span data-dict-value="current">Current:</span> </B><div style="display: inline" id="unified_spread_placeholder">Unified Spread<br></div>			
			<div class="column">
				<B><span data-dict-value="unified">Unified</span> <span data-dict-value="bids">Bids</span></B><BR>
				<div style="display: inline" id="unified_bids_placeholder"><span data-dict-value="unified">Unified</span> <span data-dict-value="bids">Bids</span><br></div>
				</font>
			</div>
		</td>
		<td style="width:26%">
		<div class="column">
			<table>
				<tr>
					<td style="height:200px">
						<BR><B><span data-dict-value="sent_transactions">Sent transactions</span></B>
						<select id="orders_limit" name="orders_limit">
							<option value="100">100</option>
							<option value="250">250</option>
							<option value="500">500</option>
						</select>
						<button type=button onclick="export_all_orders()" data-dict-value="export_all_orders">Export all orders</button>
						<button type=button onclick="export_shown_orders()" data-dict-value="export_shown_orders">Export shown orders</button>
						<div id="sent_transactions_placeholder" class=scrollable></div>
					</td>
				</tr>				
				<tr>
					<td style="height:200px">
						<div class=scrollable>
							<BR><B><span data-dict-value="bitstamp">Bitstamp</span> <span data-dict-value="transactions">Transactions</span></B>
							<div id="bitstamp_transactions_placeholder", data-dict-value="unavailable">Unavailable</div>
						</div>
					</td>
				</tr>
			</table>
		</div>
		</td>
		</font>		
		</tr>
		</table>
        <form>
			<span data-dict-value="size">Size:</span>
			<input type="number" id="size_coin" name="size_coin">
			<span data-dict-value="price">Price:</span>
			<input type="number" id="price_fiat" name="price_fiat">
			<select id="fiat_type" name="fiat_type">
				<option value="USD" data-dict-value="usd">USD</option>
			</select>
			<select id="action_type" name="action_type" onchange="should_enable_timed_orders()">
				<option value="sell" data-dict-value="sell">Sell</option>
				<option value="buy" data-dict-value="buy">Buy</option>
				<option value="timed_sell" data-dict-value="timed_sell">Timed Sell Taking</option>
				<option value="timed_buy" data-dict-value="timed_buy">Timed Buy Taking</option>
				<option value="sell_limit" data-dict-value="sell_limit">Timed Sell Making</option>				
				<option value="buy_limit" data-dict-value="buy_limit">Timed Buy Making</option>
			</select>
			<select id="exchange" name="exchange">
				<option value="Best" data-dict-value="best_exchange">Best Exchange</option>
				<option value="Bitstamp" data-dict-value="bitstamp">Bitstamp</option>
				<option value="Bitfinex" data-dict-value="bitfinex">Bitfinex</option>
				<option value="Kraken" data-dict-value="kraken">Kraken</option>
			</select>
			<span data-dict-value="duration">Duration (minutes):</span>
			<input type="number" step="1" id="order_duration" name="order_duration">
			<span data-dict-value="max_order_size">Max Order Size:</span>
			<input type="number" id="max_order_size" name="max_order_size">
			<button type=button onclick="execute_order()" name="btnExecute" id="btnExecute" data-dict-value="execute">Execute</button>
			<button type=button onclick="cancel_time_action()" name="btnCancelTimeOrder" id="btnCancelTimeOrder" data-dict-value="cancel_timed_order">Cancel Timed Order</button>
		</form>
		<h4 data-dict-value="timed_order_status">Timed order status:</h4>
		<B><div style="display: inline" id="timed_order_status_placeholder">Inactive</div></B>
		<span data-dict-value="order_details">Order details:</span>
		<B><div style="display: inline" id="timed_order_details_placeholder"></div></B>
		<span data-dict-value="sent_time">Sent time:</span>
		<B><div style="display: inline" id="timed_order_sent_time_placeholder"></div></B>
		<span data-dict-value="order_size">Order size:</span>
		<B><div style="display: inline" id="timed_order_total_size_placeholder"></div></B>
		<span data-dict-value="order_duration">Order duration (min):</span>
		<B><div style="display: inline" id="timed_order_duration"></div></B>
		<BR>
		<span data-dict-value="execution_status">Status:</span>
		<B><div style="display: inline" id="timed_order_execution_status_placeholder"></div></B>		
		<span data-dict-value="execution_start_time">Execution start time:</span>
		<B><div style="display: inline" id="timed_order_execution_start_time_placeholder"></div></B>
		<span data-dict-value="order_duration">Order duration (min):</span>
		<B><div style="display: inline" id="timed_order_execution_duration"></div></B>
		<span data-dict-value="execution_size">Executed size:</span>
		<B><div style="display: inline" id="timed_order_current_size_placeholder"></div></B>
        <script type="text/javascript">
		should_enable_timed_orders();
        var bitstampBidsPlaceholder = document.getElementById("bitstamp_bids_placeholder"),
            bitstampAsksPlaceholder = document.getElementById("bitstamp_asks_placeholder"),
			bitstampSpreadPlaceholder = document.getElementById("bitstamp_spread_placeholder"),
			bitfinexBidsPlaceholder = document.getElementById("bitfinex_bids_placeholder"),
            bitfinexAsksPlaceholder = document.getElementById("bitfinex_asks_placeholder"),
			bitfinexSpreadPlaceholder = document.getElementById("bitfinex_spread_placeholder"),
			gdaxBidsPlaceholder = document.getElementById("gdax_bids_placeholder"),
            gdaxAsksPlaceholder = document.getElementById("gdax_asks_placeholder"),
			gdaxSpreadPlaceholder = document.getElementById("gdax_spread_placeholder"),
			krakenBidsPlaceholder = document.getElementById("kraken_bids_placeholder"),
            krakenAsksPlaceholder = document.getElementById("kraken_asks_placeholder"),
			krakenSpreadPlaceholder = document.getElementById("kraken_spread_placeholder"),			
			unifiedBidsPlaceholder = document.getElementById("unified_bids_placeholder"),
            unifiedAsksPlaceholder = document.getElementById("unified_asks_placeholder"),
			unifiedSpreadPlaceholder = document.getElementById("unified_spread_placeholder"),
			currency_type = "",
			transaction_fee = 0,
			available_crypto = {},
			available_fiat = {},
			all_exchanges = ["Bitstamp", "Bitfinex", "GDAX", "Kraken", "Unified"],
			i = 0,
			language_dict = null,
			signed_in_users = {'Bitstamp': false, 'Bitfinex': false, 'Kraken': false};
			btnLogout.disabled = true;
			set_currency_type();			
			refresh_bitstamp_transactions();
			show_sent_orders();
			var url_lang = getParameterByName("language");
			if (url_lang == null)
			{
				url_lang = "en_us";
			}
			set_text_language(url_lang);
			window.setInterval(function(){
			var orders_request_suffix = currency_type + "-USD";
			var orderbooks_request = new XMLHttpRequest();
			orderbooks_request.open("GET", "/ActiveOrderbooks/" + orders_request_suffix, true);
			var bitstamp_request = new XMLHttpRequest();
			bitstamp_request.open("GET", "/Orderbook/Bitstamp/" + orders_request_suffix, true);
			var bitfinex_request = new XMLHttpRequest();
			bitfinex_request.open("GET", "/Orderbook/Bitfinex/" + orders_request_suffix, true);
			var gdax_request = new XMLHttpRequest();
			gdax_request.open("GET", "/Orderbook/GDAX/" + orders_request_suffix, true);
			var kraken_request = new XMLHttpRequest();
			kraken_request.open("GET", "/Orderbook/Kraken/" + orders_request_suffix, true);
			var unified_request = new XMLHttpRequest();
			unified_request.open("GET", "/Orderbook/Unified/" + orders_request_suffix, true);
			function get_orders(orders_request, asksPlaceholder, bidsPlaceholder, spreadPlaceholder, averageSpreadPlaceholder, 
								show_source, last_placeholder, buy_rate_placeholder, sell_rate_placeholder, buy_price_placeholder,
								sell_price_placeholder) {
				//if (orders_request.readyState == 4 && orders_request.status == 200) {
					var orders_response = orders_request;//JSON.parse(orders_request.responseText.replace(/'/g, '"'));
					if (orders_response.currency == currency_type + "-USD")
					{
						set_commands(bidsPlaceholder, orders_response.bids, show_source, false);
						set_commands(asksPlaceholder, orders_response.asks, show_source, true);
						if (averageSpreadPlaceholder != null)
						{
							averageSpreadPlaceholder.innerHTML = orders_response.average_spread.toFixed(2);
						}
						if (orders_response.asks.length == 0 || orders_response.bids.length == 0)
						{
							orders_spread = 0;
						}
						else
						{
							orders_spread = parseFloat(orders_response.asks[0].price) - parseFloat(orders_response.bids[0].price);
						}
						
						spread_html = orders_spread.toFixed(2);
						if (orders_spread < 0)
						{
							spread_html = '<font color = "red">' + spread_html + '</html>';
						}
						spreadPlaceholder.innerHTML = spread_html;
						
						if (last_placeholder != null)
						{
							if (orders_response["last_price"] == null)
							{
								last_placeholder.innerHTML = "";
							}
							else
							{
								last_colors = {'buy': "Green", 'sell': "Red"};
								var last_time = new Date(orders_response.last_price.time * 1000);
								var hours = last_time.getUTCHours();
								var minutes = String(last_time.getUTCMinutes()).padStart(2, "0");
								var seconds =  String(last_time.getSeconds()).padStart(2, "0");
								last_placeholder.innerHTML = '<font color = "' + last_colors[orders_response.last_price.type] + '">' + 
															 parseFloat(orders_response.last_price.price).toFixed(2) + 
															 " " + hours + ":" + minutes + ":" + seconds + "</font>";
								if (buy_rate_placeholder != null && sell_rate_placeholder != null && buy_price_placeholder != null &&
									sell_price_placeholder != null)
								{
									buy_rate_placeholder.innerHTML = orders_response.rate.buy_size.toFixed(3);
									sell_rate_placeholder.innerHTML = orders_response.rate.sell_size.toFixed(3);
									buy_price_placeholder.innerHTML = orders_response.rate.buy_price.toFixed(2);
									sell_price_placeholder.innerHTML = orders_response.rate.sell_price.toFixed(2);
								}
							}
						}
					}
				//}
			}
			
			function set_commands(ordersPlaceholder, orders, show_source, reverse_order)
			{
				var order_colors = {"Bitstamp" : "Blue", "Bitfinex" : "Green", "GDAX" : "Olive", "Kraken": "DarkMagenta"};
				ordersPlaceholder.innerHTML = '';
				for(i = 0; i < orders.length; i += 1) {
					var new_order_html = orders[i].size.toFixed(4) + ' ' + get_language_element('buy_at','@') + ' ' + orders[i].price.toFixed(2);
					if (show_source)
					{
						new_order_html = new_order_html + '<font color = "' + order_colors[orders[i].source] + '">(' + 
										 get_language_element(orders[i].source.toLowerCase(), orders[i].source) + ')</font>';
					}
					new_order_html = new_order_html + '<br />';
					if (reverse_order)
					{
						ordersPlaceholder.innerHTML = new_order_html + ordersPlaceholder.innerHTML;
					}
					else
					{
						ordersPlaceholder.innerHTML = ordersPlaceholder.innerHTML + new_order_html;
					}
				}
			}
			
			orderbooks_request.onreadystatechange = function() {
				if (orderbooks_request.readyState == 4 && orderbooks_request.status == 200) 
				{
					var orders_response = JSON.parse(orderbooks_request.responseText.replace(/'/g, '"'));
					known_exchanges = {"Bitstamp": false, "Bitfinex": false, "GDAX": false, "Kraken": false};
					active_exchanges = [];
					for (var exchange_name in orders_response)
					{
						if (known_exchanges[exchange_name] != null)
						{
							active_exchanges.push(exchange_name);
						}
						known_exchanges[exchange_name] = true;
						table_columns = [document.getElementById(exchange_name.toLowerCase() + "_header"),
										 document.getElementById(exchange_name.toLowerCase() + "_content")]
						for (var curr_td in table_columns)
						{
							if (table_columns[curr_td] != null)
							{
								table_columns[curr_td].style.background = "";
							}
						}
						var show_source = false;
						if (exchange_name == "Unified")
						{
							show_source = true;
						}
						get_orders(orders_response[exchange_name], document.getElementById(exchange_name.toLowerCase() + "_asks_placeholder"),
								   document.getElementById(exchange_name.toLowerCase() + "_bids_placeholder"),
								   document.getElementById(exchange_name.toLowerCase() + "_spread_placeholder"), 
								   document.getElementById(exchange_name.toLowerCase() + "_average_spread_placeholder"), show_source,
								   document.getElementById(exchange_name.toLowerCase() + "_last_placeholder"));
					}
					
					set_exchanges_in_select(active_exchanges.slice(), false, false, sign_in_exchange);
					set_exchanges_in_select(active_exchanges.slice(), true, true, exchange);
					if (exchange.options.length == 0)
					{
						btnExecute.disabled = true;
					}
					
					empty_response = {"asks": [], "bids": [], "currency": orders_request_suffix, "average_spread": 0};
					for (var exchange_name in known_exchanges)
					{
						if (!known_exchanges[exchange_name])
						{
							table_columns = [document.getElementById(exchange_name.toLowerCase() + "_header"),
											 document.getElementById(exchange_name.toLowerCase() + "_content")]
							for (var curr_td in table_columns)
							{
								if (table_columns[curr_td] != null)
								{
									table_columns[curr_td].style.background = "Silver";
								}
							}
							
							get_orders(empty_response, document.getElementById(exchange_name.toLowerCase() + "_asks_placeholder"),
								   document.getElementById(exchange_name.toLowerCase() + "_bids_placeholder"),
								   document.getElementById(exchange_name.toLowerCase() + "_spread_placeholder"), 
								   document.getElementById(exchange_name.toLowerCase() + "_average_spread_placeholder"), show_source,
								   document.getElementById(exchange_name.toLowerCase() + "_last_placeholder"))
						}
					}
				}
				//get_orders(bitstamp_request, bitstampAsksPlaceholder, bitstampBidsPlaceholder, bitstampSpreadPlaceholder, 
				//		   bitstamp_average_spread_placeholder, false, bitstamp_last_placeholder/*, bitstamp_buy_rate_placeholder,
				//		   bitstamp_sell_rate_placeholder, bitstamp_buy_price_placeholder, bitstamp_sell_price_placeholder*/);
			};
			orderbooks_request.send();
			bitstamp_request.onreadystatechange = function() {

				get_orders(bitstamp_request, bitstampAsksPlaceholder, bitstampBidsPlaceholder, bitstampSpreadPlaceholder, 
						   bitstamp_average_spread_placeholder, false, bitstamp_last_placeholder/*, bitstamp_buy_rate_placeholder,
						   bitstamp_sell_rate_placeholder, bitstamp_buy_price_placeholder, bitstamp_sell_price_placeholder*/);
			};

			bitfinex_request.onreadystatechange = function() {
				get_orders(bitfinex_request, bitfinexAsksPlaceholder, bitfinexBidsPlaceholder, bitfinexSpreadPlaceholder, 
						   bitfinex_average_spread_placeholder, false, bitfinex_last_placeholder/*, bitfinex_buy_rate_placeholder,
						   bitfinex_sell_rate_placeholder, bitfinex_buy_price_placeholder, bitfinex_sell_price_placeholder*/);
			};
			
			gdax_request.onreadystatechange = function() {
				get_orders(gdax_request, gdaxAsksPlaceholder, gdaxBidsPlaceholder, gdaxSpreadPlaceholder, 
						   gdax_average_spread_placeholder, false, gdax_last_placeholder);
			};
			
			kraken_request.onreadystatechange = function() {
				get_orders(kraken_request, krakenAsksPlaceholder, krakenBidsPlaceholder, krakenSpreadPlaceholder, 
						   kraken_average_spread_placeholder, false, kraken_last_placeholder);
			};
			
			unified_request.onreadystatechange = function() {

				get_orders(unified_request, unifiedAsksPlaceholder, unifiedBidsPlaceholder, unifiedSpreadPlaceholder, null, true, null);
			};
			
			/*bitstamp_request.send();
			bitfinex_request.send();
			unified_request.send();
			kraken_request.send();
			gdax_request.send();*/
		}, 2000);
		
		var time_order_running = false;
		window.setInterval(function(){
			var time_order_request = new XMLHttpRequest();
			time_order_request.open("GET", "/GetTimedOrderStatus", true);
			time_order_request.onreadystatechange = function() {
				if (time_order_request.readyState == 4 && time_order_request.status == 200) {
					var time_order_response = JSON.parse(time_order_request.responseText.replace(/'/g, '"'));
					time_order_running = (time_order_response.timed_order_running == 'True');
					btnCancelTimeOrder.disabled = !time_order_running;
					should_enable_timed_orders();
					var timed_order_status_dict = {"True" : get_language_element("active","Active"), "False" : get_language_element("inactive","Inactive")};
					timed_order_status_placeholder.innerHTML = timed_order_status_dict[time_order_response.timed_order_running];
					timed_order_details_placeholder.innerHTML = time_order_response.action_type + " " + get_language_element("for","for") + 
						" " + time_order_response.timed_order_price_fiat + " " + get_language_element("usd","USD");
					
					var timed_order_status = get_language_element('not_started', "Not started");
					if (time_order_response.timed_order_required_size > 0)
					{
						var sent_time = new Date(time_order_response.timed_order_sent_time * 1000);
						timed_order_sent_time_placeholder.innerHTML = 
							sent_time.getHours().toString().padStart(2,"0") + ":" + sent_time.getMinutes().toString().padStart(2,"0") + 
							":" + sent_time.getSeconds().toString().padStart(2,"0");
						if (time_order_response.timed_order_running == "True")
						{
							if (time_order_response.timed_order_execution_start_time != "")
							{
								timed_order_status = get_language_element('running', "Running");
							}
							else
							{
								timed_order_status = get_language_element('pending', "Pending");
							}
						}
						else
						{
							if (time_order_response.timed_order_required_size - 0.0001 > time_order_response.timed_order_done_size)
							{
								timed_order_status = get_language_element('cancelled', "Cancelled");
							}
							else
							{
								timed_order_status = get_language_element('done', "Done");
							}
						}
						timed_order_execution_status_placeholder.innerHTML = timed_order_status;
						var start_time = new Date(time_order_response.timed_order_execution_start_time * 1000);
						timed_order_execution_start_time_placeholder.innerHTML = 
							start_time.getHours().toString().padStart(2,"0") + ":" + start_time.getMinutes().toString().padStart(2,"0") + 
							":" + start_time.getSeconds().toString().padStart(2,"0");
						timed_order_total_size_placeholder.innerHTML = time_order_response.timed_order_required_size;
						timed_order_current_size_placeholder.innerHTML = time_order_response.timed_order_done_size.toFixed(4);
						timed_order_duration.innerHTML = (time_order_response.timed_order_duration_sec / 60).toFixed(0);
						var minutes = Math.floor(time_order_response.timed_order_elapsed_time / 60);
						var seconds = time_order_response.timed_order_elapsed_time - minutes * 60;
						//alert(time_order_response.server_time + "\n" + time_order_response.timed_order_execution_start_time + "\n" + 
						//	(time_order_response.server_time - time_order_response.timed_order_execution_start_time));
						var execution_duration = /*new Date*/(time_order_response.server_time - time_order_response.timed_order_execution_start_time);
						//alert(execution_duration);
						//timed_order_execution_duration.innerHTML = (execution_duration.getHours() * 60 + execution_duration.getMinutes()).toString().padStart(2,"0") +
						//	":" + execution_duration.getSeconds().toString().padStart(2,"0");
						var execution_minutes = Math.floor(execution_duration / 60);
						var execution_seconds = Math.floor(execution_duration - 60 * execution_minutes);
						if (time_order_response.timed_order_running == "True")
						{
							timed_order_execution_duration.innerHTML = execution_minutes.toString().padStart(2,"0") + ":" + execution_seconds.toString().padStart(2,"0");
						}
						timed_order_current_size_placeholder.innerHTML = time_order_response.timed_order_done_size.toFixed(4); 	 	
					}
				}
			};
			time_order_request.send();	
		}, 5000);
		
		function str_pad_left(string,pad,length) {
			return (new Array(length+1).join(pad)+string).slice(-length);
		}
		
		window.setInterval(function(){
			refresh_all_accounts_balance();
			refresh_bitstamp_transactions();
			get_exchange_credentials();
		}, 5000);
		
		window.setInterval(function(){
			show_sent_orders();
		}, 1000);


		function can_execute_order(action_type, size_crypto, price_fiat, timed_order, duration, max_order_size)
		{
			var can_execute = false;
			var execute_exchange = exchange.value;
			if (execute_exchange != "Best" && !signed_in_users[execute_exchange])
			{
				alert("User not signed in to " + execute_exchange + ", can't execute orders");
			}
			else if (size_crypto == "" || size_crypto <= 0)
			{
				alert("Invalid size");
			}
			else if (price_fiat == "" || price_fiat <= 0)
			{
				alert("Invalid price");
			}
			else if(timed_order && (duration == "" || duration < 0))
			{
				alert("Invalid duration");
			}
			else if(timed_order && (max_order_size == "" || max_order_size < 0))
			{
				alert("Invalid max order size");
			}
			else if (execute_exchange != "Best" && action_type == 'buy' && available_fiat[execute_exchange] < size_crypto * price_fiat * (1 + 0.01 * transaction_fee))
			{
				var required_fiat = size_crypto * price_fiat * (1 + 0.01 * transaction_fee);
				alert("Insufficient funds: the order requires " + required_fiat.toFixed(2) + " USD");
			}
			else if (execute_exchange != "Best" && action_type == 'sell' && available_crypto[execute_exchange] < size_crypto)
			{
				alert("Insufficient funds: the order requires " + size_crypto + " " + crypto_type.value);
			}
			else
			{
				can_execute = true;
			}
			return can_execute;
		}
		
		function execute_order()
		{
			var action_order_duration = 0;
			var timed_order = false;
			var alert_text = "";
			var order_action_type = action_type.value;
			if (order_action_type == "timed_sell" || order_action_type == "sell_limit")
			{
				order_action_type = "sell";
				action_order_duration = order_duration.value;
				alert_text = "Going to sell " + size_coin.value + " " + crypto_type.value + " for at least " + price_fiat.value + " " + 
							 fiat_type.value + " over " + action_order_duration + " minutes";
				timed_order = true;
			}
			else if(order_action_type == "timed_buy" || order_action_type == "buy_limit")
			{
				order_action_type = "buy";
				action_order_duration = order_duration.value;
				alert_text = "Going to buy " + size_coin.value + " " + crypto_type.value + " for up to " + price_fiat.value + " " + 
							 fiat_type.value + " over " + action_order_duration + " minutes";
				timed_order = true;
			}
			else
			{
				alert_text = "Going to " + action_type.value + " " + size_coin.value + " " + crypto_type.value + " for " + price_fiat.value + " " + fiat_type.value;
			}
			
			var confirmed = false
			if(can_execute_order(order_action_type, size_coin.value, price_fiat.value, timed_order, action_order_duration, max_order_size.value) && 
				confirm(alert_text))
			{
				var max_order_size_num = 0;
				if (max_order_size.value != "")
				{
					max_order_size_num = parseFloat(max_order_size.value);
				}
				btnExecute.disabled = true;
				var exchanges = null;
				if (exchange.value == "Best")
				{
					exchanges = [];
					for (var curr_option = 0; curr_option < exchange.options.length; ++curr_option)
					{
						if (exchange.options[curr_option].value != "Best")
						{
							exchanges.push(exchange.options[curr_option].value);
						}
					}
				}
				else
				{
					exchanges = [exchange.value];
				}
				var order_params = JSON.stringify({"action_type": action_type.value,
												   "size_coin": size_coin.value,
												   "crypto_type": crypto_type.value,
												   "price_fiat": price_fiat.value,
												   "fiat_type": fiat_type.value,
												   "duration_sec": action_order_duration * 60,
												   "max_order_size": max_order_size_num,
												   "exchanges": exchanges});
				var order_request = new XMLHttpRequest();
				order_request.open("POST", "/SendOrder", true);
				order_request.setRequestHeader("Content-Type", "application/json");
				order_request.onreadystatechange = function () {
					if (order_request.readyState === 4 && order_request.status === 200) {
						var order_response = JSON.parse(order_request.responseText.replace(/'/g, '"'));
						if (order_response.order_status == "True")
						{
							if (timed_order)
							{
								alert("Timed order posted to server successfully");
							}
							else
							{
								alert("Order executed successfully");
							}
						}
						else
						{
							alert("Order execution failed");
						}
						btnExecute.disabled = false;
						should_enable_timed_orders();
						refresh_all_accounts_balance();
						show_sent_orders();
					}
				};
				order_request.send(order_params);
			}
			
		}
		
		/*function refresh_bitstamp_balance()
		{
			refresh_account_balance("usd_balance_placeholder_1", "crypto_available_balance_placeholder_1", "Bitstamp", currency_type, 1);
		}
		
		function refresh_bitfinex_balance()
		{
			refresh_account_balance("usd_balance_placeholder_2", "crypto_available_balance_placeholder_2", "Bitfinex", currency_type, 2);
		}
		
		function refresh_kraken_balance()
		{
			refresh_account_balance("usd_balance_placeholder_4", "crypto_available_balance_placeholder_4", "Kraken", currency_type, 4);
		}*/
		
		/*function refresh_account_balance(fiat_balance_id, crypto_balance_id, exchange, currency, exchange_index)
		{
			var exchangeFiatPlaceholder = document.getElementById(fiat_balance_id),
				exchangeCryptoPlaceholder = document.getElementById(crypto_balance_id);
			var account_request = new XMLHttpRequest();
			account_request.open("GET", "/AccountBalance/" + exchange, true);
			
			account_request.onreadystatechange = function() {
				if (account_request.readyState == 4 && account_request.status == 200) {
					var account_response = JSON.parse(account_request.responseText.replace(/'/g, '"'));
					var not_available_text = get_language_element('not_available', 'N/A');
					available_fiat[exchange] = not_available_text;
					var exchange_available_crypto = not_available_text;
					var balances = account_response.balances;
					if (balances != null)
					{
						exchangeCryptoPlaceholder.innerHTML = "";
						var total_usd_value = 0;
						if (balances.USD != null && balances.USD.available != null && balances.USD.amount != null)
						{
							//alert(balances.USD.available + " " + account_response.server_usd_reserved + 
							//" " + (balances.USD.available - account_response.server_usd_reserved));
							available_fiat[exchange] = balances.USD.available - account_response.server_usd_reserved;
							// /*var x = balances.USD.available - account_response.server_usd_reserved;
							//alert(x);
							//available_fiat[exchange] = x;
							//alert(exchange + " " + typeof(available_fiat) + " " + typeof(available_fiat[exchange]) + " " + available_fiat[exchange]);
							exchangeFiatPlaceholder.innerHTML = balances.USD.available.toFixed(2) + "(" + available_fiat[exchange].toFixed(2) + ")";
							total_usd_value = balances.USD.amount;
						}
						currencies = ['BTC', 'BCH'];
						if (currency_type == "BCH")
						{
							currencies = ['BCH', 'BTC'];
						}
						
						for (var currency_index in currencies)
						{
							var currency = currencies[currency_index];
							if (balances[currency] != null)
							{
								exchange_available_crypto = balances[currency].available;
								var curr_available_crypto = exchange_available_crypto;
								if (account_response.reserved_crypto_type == currency && account_response.reserved_crypto != null)
								{
									curr_available_crypto = exchange_available_crypto - account_response.reserved_crypto;
								}
								
								if (currency_index == 0)
								{
									available_crypto[exchange] = curr_available_crypto;
								}
								
								exchangeCryptoPlaceholder.innerHTML = exchangeCryptoPlaceholder.innerHTML + get_language_element(currency, currency) + " " + get_language_element("balance", "Balance:") + 
									" " + exchange_available_crypto.toFixed(4) + "(" + curr_available_crypto.toFixed(4) + ")<br>";
								if (balances[currency].price != null)
								{
									total_usd_value += balances[currency].price * exchange_available_crypto;
								}
							}
						}
						exchangeCryptoPlaceholder.innerHTML = exchangeCryptoPlaceholder.innerHTML + get_language_element("total", "Total") + " " + get_language_element("usd_balance", "USD Balance:") + 
							" " + total_usd_value.toFixed(2);
					}
					else
					{
						reset_balances(exchange_index);
					}
					
					transaction_fee = 0;
					if (account_response.fee != null)
					{
						transaction_fee = account_response.fee;
					}
				}
			};
			account_request.send();	
		}*/
		
		function refresh_all_accounts_balance()
		{
			var account_request = new XMLHttpRequest();
			account_request.open("GET", "/AccountBalance", true);
			account_request.onreadystatechange = function() {
				if (account_request.readyState == 4 && account_request.status == 200) {
					var account_response = JSON.parse(account_request.responseText.replace(/'/g, '"'));
					var not_available_text = get_language_element('not_available', 'N/A');
					for (var curr_exchange in account_response)
					{
						var exchangeCryptoPlaceholder = document.getElementById("crypto_available_balance_placeholder_" + curr_exchange.toLowerCase());
						var exchangeFiatPlaceholder = document.getElementById("usd_balance_placeholder_" + curr_exchange.toLowerCase());
						available_fiat[curr_exchange] = not_available_text;
						var exchange_available_crypto = not_available_text;
						var balances = account_response[curr_exchange].balances;
						if (balances != null)
						{
							exchangeCryptoPlaceholder.innerHTML = "";
							var total_usd_value = 0;
							if (balances.USD != null && balances.USD.available != null && balances.USD.amount != null)
							{
								available_fiat[curr_exchange] = balances.USD.available - account_response[curr_exchange].server_usd_reserved;
								exchangeFiatPlaceholder.innerHTML = balances.USD.available.toFixed(2) + "(" + available_fiat[curr_exchange].toFixed(2) + ")";
							}
							currencies = ['BTC', 'BCH'];
							if (currency_type == "BCH")
							{
								currencies = ['BCH', 'BTC'];
							}
							
							for (var currency_index in currencies)
							{
								var currency = currencies[currency_index];
								if (balances[currency] != null)
								{
									exchange_available_crypto = balances[currency].available;
									var curr_available_crypto = exchange_available_crypto;
									if (account_response.reserved_crypto_type == currency && account_response.reserved_crypto != null)
									{
										curr_available_crypto = exchange_available_crypto - account_response.reserved_crypto;
									}
									
									if (currency_index == 0)
									{
										available_crypto[exchange] = curr_available_crypto;
									}
									
									exchangeCryptoPlaceholder.innerHTML = exchangeCryptoPlaceholder.innerHTML + get_language_element(currency, currency) + " " + get_language_element("balance", "Balance:") + 
										" " + exchange_available_crypto.toFixed(4) + "(" + curr_available_crypto.toFixed(4) + ")<br>";
								}
							}
							exchangeCryptoPlaceholder.innerHTML = exchangeCryptoPlaceholder.innerHTML + get_language_element("total", "Total") + " " + get_language_element("usd_balance", "USD Balance:") + 
								" " + account_response[curr_exchange].total_usd_value.toFixed(2);
						}
						else
						{
							reset_balances(curr_exchange);
						}
						
						transaction_fee = 0;
						if (account_response.fee != null)
						{
							transaction_fee = account_response[curr_exchange].fee;
						}
					}
				}
			};
			account_request.send();	
		}		
		
		function refresh_bitstamp_transactions()
		{
			var bitstampTransactionsPlaceholder = document.getElementById("bitstamp_transactions_placeholder");
			if (!signed_in_users["Bitstamp"])
			{
				bitstampTransactionsPlaceholder.innerHTML = get_language_element("unavailable","Unavailable");
			}
			else
			{
				var bitstamp_transactions_request = new XMLHttpRequest();
				bitstamp_transactions_request.open("GET", "/Transactions/Bitstamp", true);
				bitstamp_transactions_request.onreadystatechange = function() {
					if (bitstamp_transactions_request.readyState == 4 && bitstamp_transactions_request.status == 200) {
						bitstampTransactionsPlaceholder.innerHTML = '';
						var bitstamp_transactions_response = JSON.parse(bitstamp_transactions_request.responseText.replace(/'/g, '"'));
						var transaction_dict = {'btc' : 'btc_usd', 
												'bch' : 'bch_usd'};
						for (i = 0; i < bitstamp_transactions_response.length; i += 1)
						{
							var found_type = "";
							var transaction_types = Object.keys(transaction_dict);
							for (var j = 0; j < transaction_types.length && found_type == ""; ++j)
							{
								transaction_keys = Object.keys(bitstamp_transactions_response[i]);
								if (Object.keys(bitstamp_transactions_response[i]).indexOf(transaction_dict[transaction_types[j]]) != -1)
								{	
									found_type = transaction_types[j];
								}
							}
							if (found_type != "")
							{
								bitstampTransactionsPlaceholder.innerHTML = bitstampTransactionsPlaceholder.innerHTML + bitstamp_transactions_response[i].datetime +
									": " + parseFloat(bitstamp_transactions_response[i][found_type]).toFixed(4) + " " + get_language_element(found_type.toUpperCase(), found_type.toUpperCase()) + " " + 
									get_language_element('buy_at','@') + parseFloat(bitstamp_transactions_response[i][transaction_dict[found_type]]).toFixed(2) + "<BR>";
							}
						}
					}
				};
				bitstamp_transactions_request.send();
			}
		}
		
		function should_enable_timed_orders()
		{
			if (action_type.value == "timed_sell" || action_type.value == "timed_buy" || 
				action_type.value == "buy_limit"|| action_type.value == "sell_limit")
			{
				order_duration.disabled = false;
				max_order_size.disabled = false;
				btnExecute.disabled = time_order_running;
			}
			else
			{
				order_duration.disabled = true;
				max_order_size.disabled = true;
				btnExecute.disabled = false;
			}
		}
		
		function cancel_time_action()
		{
			var cancel_time_order_request = new XMLHttpRequest();
			cancel_time_order_request.open("GET", "/CancelTimedOrder", true);
			cancel_time_order_request.onreadystatechange = function() {
				if (cancel_time_order_request.readyState == 4 && cancel_time_order_request.status == 200) {
					var cancel_time_order_response = JSON.parse(cancel_time_order_request.responseText.replace(/'/g, '"'));
					var cancel_msg = "Cacel time order: ";
					if (cancel_time_order_response.cancel_time_order_result)
					{
						cancel_msg = cancel_msg + "Success";
						refresh_all_accounts_balance();
					}
					else
					{
						cancel_msg = cancel_msg + "Failure";
					}
					alert(cancel_msg);
				}
			};
			cancel_time_order_request.send();
		}
		
		function get_sent_orders(limit, _callback)
		{
			var sent_orders_request = new XMLHttpRequest();
			sent_orders_request.open("GET", "/GetSentOrders?limit=" + limit, true);
			sent_orders_request.onreadystatechange = function() {
				if (sent_orders_request.readyState == 4 && sent_orders_request.status == 200) {
					var sent_orders_response = JSON.parse(sent_orders_request.responseText.replace(/'/g, '"'));
					_callback(sent_orders_response);
					
				}
			};
			sent_orders_request.send();
		}
		
		function show_sent_orders()
		{
			var timed_order_dict = {0 : get_language_element("manual_short","M"), 1 : get_language_element("timed_short","T")};
			var exchange_display_dict = {"Bitstamp" : get_language_element("bitstamp_short","BSMP"),
										 "Bitfinex" : get_language_element("bitfinex_short","BFNX"),
										 "Kraken" : get_language_element("kraken_short","KRKN")};

			var action_type_dict = {"buy" : "+", "sell" : "-", "buy_limit": "+?", "sell_limit": "-?"};
			get_sent_orders(orders_limit.value, function(sent_orders_response) {
			sent_transactions_placeholder.innerHTML = '';
			var order_type_colors_dict = {'buy':'"Green"', 'sell':'"Red"', 'buy_limit': '"Green"', 'sell_limit': '"Red"'};
			for (i = 0; i < sent_orders_response.length; i++)
			{
				if (sent_orders_response[i].status != "Make Order")
				{
					var exchange_display = exchange_display_dict[sent_orders_response[i].exchange];
					if (exchange_display == null)
					{
						exchange_display = sent_orders_response[i].exchange;
					}
					
					var curr_transaction = '<font color = ' + order_type_colors_dict[sent_orders_response[i].action_type] + ' >' + exchange_display +
						" " + sent_orders_response[i].order_time + "(" + timed_order_dict[sent_orders_response[i].timed_order] + "): " +
						action_type_dict[sent_orders_response[i].action_type] + parseFloat(sent_orders_response[i].crypto_size).toFixed(4) + 
						get_language_element(sent_orders_response[i].crypto_type,sent_orders_response[i].crypto_type) +
						" " + get_language_element('buy_at','@') + sent_orders_response[i].price_fiat.toFixed(2) + "," + 
						get_language_element(sent_orders_response[i].status.toLowerCase(),sent_orders_response[i].status);
						
					if (sent_orders_response[i].ask != 0 || sent_orders_response[i].bid != 0)
					{
						curr_transaction = curr_transaction + " " + sent_orders_response[i].ask + "/" + sent_orders_response[i].bid;
					}
					sent_transactions_placeholder.innerHTML = sent_transactions_placeholder.innerHTML + curr_transaction + "</font><BR>";
				}
			}})
		}
		
		function set_currency_type()
		{
			currency_type = crypto_type.value;
			reset_balances();
			var placeholder_names = [];
			var placeholder_suffixes = ["_bids_placeholder", "_asks_placeholder", "_last_placeholder"];
			for (var curr_exchange in all_exchanges)
			{
				for (var suffix in placeholder_suffixes)
				{
					placeholder_names.push(all_exchanges[curr_exchange].toLowerCase() + placeholder_suffixes[suffix]);
				}
			}
			/*var placeholder_names = ["bitstamp_bids_placeholder", "bitstamp_asks_placeholder", "bitfinex_bids_placeholder",
									 "bitfinex_asks_placeholder", "gdax_bids_placeholder", "gdax_asks_placeholder",
									 "unified_bids_placeholder", "unified_asks_placeholder", "bitstamp_last_placeholder",
									 "bitfinex_last_placeholder", "gdax_last_placeholder"];*/
			for (var placeholder_index = 0; placeholder_index < placeholder_names.length; ++placeholder_index){
				curr_placeholder = document.getElementById(placeholder_names[placeholder_index]);
				if (curr_placeholder != null)
				{
					curr_placeholder.innerHTML = "";
				}
			}

			refresh_all_accounts_balance();
		}
		
		function reset_balances(exchange_name)
		{
			var main_currency_type_text = get_language_element(crypto_type.value, crypto_type.value);
			var other_currencies_texts = [];
			var not_available_text = get_language_element("not_available", "N/A");
			for (var coin_index = 0; coin_index < crypto_type.length; ++coin_index)
			{
				if (crypto_type[coin_index].value != crypto_type.value)
				{
					other_currencies_texts.push(get_language_element(crypto_type[coin_index].value, crypto_type[coin_index].value));
				}
			}
			
			var exchanges_to_resest = all_exchanges;
			if (exchange_name != null)
			{
				exchanges_to_resest = [exchange_name];
			}
			
			for (var curr_exchange in exchanges_to_resest)
			{
				var usd_balance_placeholder = document.getElementById("usd_balance_placeholder_" + exchanges_to_resest[curr_exchange].toLowerCase());
				var balance_type_placeholder = document.getElementById("crypto_available_balance_placeholder_" + exchanges_to_resest[curr_exchange].toLowerCase());
				usd_balance_placeholder.innerHTML = get_language_element("not_available", "N/A");
				var balance_text = get_language_element('balance', "Balance:");
				if (balance_type_placeholder != null)
				{
					balance_type_placeholder.innerHTML = main_currency_type_text + " " + balance_text + " " + not_available_text + "<br>";
					for (var coin_index = 0; coin_index < other_currencies_texts.length; ++coin_index)
					{
						balance_type_placeholder.innerHTML = balance_type_placeholder.innerHTML + 
							other_currencies_texts[coin_index] + " " + balance_text + " " + not_available_text + "<br>";
					}
					balance_type_placeholder.innerHTML = balance_type_placeholder.innerHTML +
						get_language_element("total", "Total") + " " + get_language_element("usd_balance", "USD Balance:") + 
						" " + not_available_text;
				}
			}
		}
		
		function set_credentials()
		{
			btnSetCredentials.disabled = true;
			var credentials_params = JSON.stringify({"username" : account_number.value,
												     "key" : api_key.value,
												     "secret" : secret.value,
													 "exchange": sign_in_exchange.value,
													 "taker_fee": taker_fee.value,
													 "maker_fee": maker_fee.value});
			var set_credentials_request = new XMLHttpRequest();
			set_credentials_request.open("POST", "/SetClientCredentials", true);
			set_credentials_request.setRequestHeader("Content-Type", "application/json");
			set_credentials_request.onreadystatechange = function () {
			if (set_credentials_request.readyState === 4 && set_credentials_request.status === 200) 
				{
					var set_credentials_response = JSON.parse(set_credentials_request.responseText.replace(/'/g, '"'));
					if (set_credentials_response.set_credentials_status == "True")
					{
						alert("Setting credentials status: success");
						signed_in_users[sign_in_exchange.value] = true;
					}
					else
					{
						alert("Setting credentials status: failure");
					}
					btnSetCredentials.disabled = false;
					refresh_bitstamp_transactions();
					refresh_all_accounts_balance();
				}
			};
			set_credentials_request.send(credentials_params);
			secret.value = "";
		}
		
		function get_exchange_credentials()
		{
			var credentials_request = new XMLHttpRequest();
			credentials_request.open("GET", "/GetSignedInCredentials", true);
			credentials_request.onreadystatechange = function() {
				if (credentials_request.readyState == 4 && credentials_request.status == 200) {
					var credentials_response = JSON.parse(credentials_request.responseText.replace(/'/g, '"'));
					for (var exchange_name in credentials_response)
					{
						if (credentials_response[exchange_name].signed_in_user != '')
						{

							signed_in_users[exchange_name] = true;
						}
						else
						{
							signed_in_users[exchange_name] = false;
						}
					}
					
					if (signed_in_users[sign_in_exchange.value])
					{
						user_placeholder.innerHTML = credentials_response[sign_in_exchange.value].signed_in_user;						
					}
					else
					{
						user_placeholder.innerHTML = get_language_element('no_user',"None");						
					}					
					btnLogout.disabled = !signed_in_users[sign_in_exchange.value];
				}
			};
			credentials_request.send();
		}
		
		function export_all_orders()
		{
			get_sent_orders(0, function (sent_orders_response) { export_orders(sent_orders_response)});
		}
		
		function export_shown_orders()
		{
			get_sent_orders(orders_limit.value, function (sent_orders_response) { export_orders(sent_orders_response)});
		}
		
		function export_orders(orders_to_export)
		{
			headers = ['Type', 'Exchange', 'Order Date and Time', 'Timed / Manual', 'Size', 'Coin', 'Price', 'Status', 'USD Balance', 'Crypto Balance'];
			headers_row = headers.join(",");
			var data_rows = '';
			var timed_order_dict = {0 : "Manual", 1 : "Timed"};
			for (var i = 0; i < orders_to_export.length; ++i)
			{
				var curr_row = [orders_to_export[i].action_type, orders_to_export[i].exchange, orders_to_export[i].order_time,
								timed_order_dict[orders_to_export[i].timed_order], parseFloat(orders_to_export[i].crypto_size).toFixed(4), 
								orders_to_export[i].crypto_type, orders_to_export[i].price_fiat, orders_to_export[i].status, 
								orders_to_export[i].usd_balance, orders_to_export[i].crypto_available];
				data_rows = data_rows + curr_row.join(",") + "\n";
			}
			var encodedUri = encodeURI('data:text/csv;charset=utf-8,'+headers_row + "\n" + data_rows);
			var link = document.createElement("a");
			link.setAttribute("href", encodedUri);
			var currentdate = new Date(); 
			var datetime = currentdate.getFullYear() + "_" + (currentdate.getMonth()+1).toString().padStart(2,"0") + "_" + currentdate.getDate().toString().padStart(2,"0") +
										"_" + currentdate.getHours().toString().padStart(2,"0") + "_" + currentdate.getMinutes().toString().padStart(2,"0") + "_" + currentdate.getSeconds().toString().padStart(2,"0");
										
			// Creating a downloadable link and clicking on it
			link.setAttribute("download", "sent_orders_" + datetime + ".csv");
			link.innerHTML= "Click Here to download";
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		}
		
		function exchange_logout(exchange, show_message)
		{
			if (exchange == null)
			{
				exchange = sign_in_exchange.value;
			}
			
			if (show_message == null)
			{
				show_message = true;
			}
			var logout_request = new XMLHttpRequest();
			logout_request.open("GET", "/Logout/" + sign_in_exchange.value, true);
			logout_request.onreadystatechange = function() {
				if (logout_request.readyState == 4 && logout_request.status == 200) {
					var logout_response = JSON.parse(logout_request.responseText.replace(/'/g, '"'));
					var logout_msg = "Logout status: ";
					if (logout_response.set_credentials_status == 'True')
					{
						logout_msg = logout_msg + "Success";
						btnLogout.disabled = true;
						refresh_bitstamp_transactions();
						refresh_all_accounts_balance();
						signed_in_users[exchange] = false;
					}
					else
					{
						logout_msg = logout_msg + "Failure";
					}
					if (show_message)
					{
						alert(logout_msg);
					}
				}
			};
			logout_request.send();		
		}
		
		function set_text_language(language)
		{
			var text_request = new XMLHttpRequest();
			text_request.open("GET", "/GetLanguageText/" + language, true);
			text_request.onreadystatechange = function() {
				if (text_request.readyState == 4 && text_request.status == 200) {
					var text_response = JSON.parse(text_request.responseText.replace(/'/g, '"'));
					language_dict = text_response;
					var elems = document.body.getElementsByTagName("*");
					for (var element_index = 0; element_index < elems.length; ++element_index)
					{
						curr_element = elems[element_index];
						if (curr_element.dataset != null && curr_element.dataset.dictValue != null)
						{
							set_element_by_dict(curr_element, text_response, curr_element.dataset.dictValue);
						}
					}
					set_currency_type();
				}
			};
			text_request.send();
		}
		
		function set_element_by_dict(element, dict, key)
		{
			if (dict[key] != null)
			{
				element.innerHTML = dict[key];
			}
		}
		
		function get_language_element(key, default_value)
		{
			var result = default_value;
			if (language_dict != null && language_dict[key] != null)
			{
				result = language_dict[key];
			}
			
			return result;
		}
		
		function getParameterByName(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
		
		function set_sign_in_exchange()
		{
			get_exchange_credentials();
		}
		
		function start_exchange(exchange)
		{
			var start_request = new XMLHttpRequest();
			start_request.open("GET", "/StartOrderbook/" + exchange, true);
			start_request.onreadystatechange = function() {
				if (start_request.readyState == 4 && start_request.status == 200) {
					alert(exchange + " Started");
				}
			}
			start_request.send();
		}
		
		function stop_exchange(exchange)
		{
			var stop_request = new XMLHttpRequest();
			stop_request.open("GET", "/StopOrderbook/" + exchange, true);
			stop_request.onreadystatechange = function() {
				if (stop_request.readyState == 4 && stop_request.status == 200) {
					alert(exchange + " Stopped");
				}
			}
			stop_request.send();		
		}
		
		function set_exchanges_in_select(exchanges, add_best, only_signed_in, selector)
		{
			var curr_value = "";
			if (selector.options.length > 0)
			{
				curr_value = selector.value;
				var initial_length = selector.length;
				for (var item_index = 0; item_index < initial_length; ++item_index)
				{
					selector.remove(0);
				}
			}

			if(only_signed_in)
			{
				for (var item_index = exchanges.length - 1; item_index >= 0; --item_index)
				{
					if (!signed_in_users[exchanges[item_index]])
					{
						exchanges.splice(item_index, 1);
					}
				}
			}
			
			if(exchanges.length > 1 && add_best)
			{
				var option = document.createElement("option");
				option.text = get_language_element("best_exchange", "Best Exchange");
				option.value = "Best";
				selector.add(option);
				if (curr_value == "Best")
				{
					selector.value = "Best";
				}
			}
			
			var found_curr_option = false;
			for (var item_index = 0; item_index < exchanges.length; ++item_index)
			{
				var option = document.createElement("option");
				option.text = get_language_element(exchanges[item_index].toLowerCase(), exchanges[item_index]);
				option.value = exchanges[item_index];
				selector.add(option);
				if (curr_value == exchanges[item_index])
				{
					found_curr_option = true;
				}
			}
			
			if (found_curr_option)
			{
				selector.value = curr_value;
			}
		}
        </script>

<div id="st-popup-container" class="st-hidden"></div></body></html>